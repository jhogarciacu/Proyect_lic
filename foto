#!/bin/bash

FOLDER="$HOME/fotos_camara_lic"
mkdir -p "$FOLDER"

echo "üì∏ Capturando fotos cada 15 segundos en: $FOLDER"
echo "‚õî Presiona Ctrl+C para detener."

while true; do
    TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
    FILENAME="photo-${TIMESTAMP}.jpg"
    FULLPATH="$FOLDER/$FILENAME"

    echo "‚Üí Capturando imagen y descargando como $FILENAME ..."

    # Captura y descarga con keep, pero con opci√≥n de espera m√°s larga
    gphoto2 --capture-image-and-download --keep --filename "$FULLPATH" > /dev/null 2>&1 &
    PID=$!

    # Esperar un tiempo m√°ximo para que termine (por seguridad)
    wait $PID

    # Verifica si se descarg√≥ el archivo
    if [[ -f "$FULLPATH" ]]; then
        FILESIZE=$(stat -c%s "$FULLPATH")
        if [[ $FILESIZE -lt 5000 ]]; then
            echo "‚ö†Ô∏è Archivo demasiado peque√±o ‚Äî posible descarga incompleta. Eliminando $FILENAME"
            rm -f "$FULLPATH"
        else
            echo "‚úÖ Guardado: $FILENAME"
        fi
    else
        echo "‚ùå No se descarg√≥ archivo."
    fi

    sleep 5
done
